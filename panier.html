<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <script defer src="compte.js"></script>
  <title>Panier - Thonsee Health</title>
</head>

<body>

<header class="tete">
       <!-- Ic√¥ne utilisateur -->
    <div class="user" onclick="toggleAccountsPopup()" style="cursor:pointer;">
  <a class="text-decoration" href="parametre.html"><div id="userIcon">üë§</div></a>
  
</div>
    <div class="logo">Thonsee <span>Health</span></div>
    <nav class="menu">
      <a href="index.html">Accueil</a>
      <a href="produits.html">Nos Produits</a>
      <a href="contact.html">Contact</a>
      <a href="panier.html">Panier <span id="cartCountNav" >0</span></a>
      <a href="#" onclick="toggleLoginPopup()">Se connecter</a>
      <a href="#" onclick="toggleRegisterPopup()">S'inscrire</a>
    </nav>
  </header>

  <main class="main" style="padding: 20px;">
    <h1 class="titre">Votre panier</h1>
    <div id="cartItems"></div>

    <button class="commande" onclick="confirmerCommande()">
      Confirmer la commande
    </button>

    <p id="confirmationMessage" style="color:green; margin-top:10px;"></p>
    <p id="totalPanier" style="font-weight:bold; margin-top:10px;">Total : 0,00 ‚Ç¨</p>
  </main>

  <!-- Pop-up Inscription -->
<div id="registerPopup" class="popup hidden">
  <div class="popup-content">
    <span class="close-btn" onclick="toggleRegisterPopup()">&times;</span>
    <h2>Inscription</h2>
    <form id="registerForm" autocomplete="on">
      <input
        type="text"
        id="registerUsername"
        name="username"
        placeholder="Nom d'utilisateur"
        maxlength="15"
        autocomplete="username"
        required
      />
      <input
        type="password"
        id="registerPassword"
        name="password"
        placeholder="Mot de passe"
        maxlength="12"
        autocomplete="new-password"
        required
      />
      <button type="submit">Cr√©er un compte</button>
    </form>
    <div id="registerMessage" style="color: rgb(255, 255, 255);"></div>
  </div>
</div>

<!-- Pop-up Connexion -->
<div id="loginPopup" class="popup hidden">
  <div class="popup-content">
    <span class="close-btn" onclick="toggleLoginPopup()">&times;</span>
    <h2>Connexion</h2>
    <form id="loginForm" autocomplete="on">
      <input
        list="usernames"
        type="text"
        id="loginUsername"
        name="username"
        placeholder="Nom d'utilisateur"
        maxlength="15"
        autocomplete="username"
        required
      />
      <datalist id="usernames"></datalist>
      <input
        type="password"
        id="loginPassword"
        name="password"
        placeholder="Mot de passe"
        maxlength="12"
        autocomplete="current-password"
        required
      />
      <button type="submit">Se connecter</button>
    </form>
    <div id="loginMessage" style="color: rgb(255, 255, 255);"></div>
  </div>
</div>

<script>
  const userName = localStorage.getItem("currentUser") || "JeanDupond";

  function getCart() {
    return JSON.parse(localStorage.getItem(`cart_${userName}`)) || [];
  }

  function saveCart(cart) {
    localStorage.setItem(`cart_${userName}`, JSON.stringify(cart));
  }

  function updateCartCount() {
    const cart = getCart();
    const totalQuantity = cart.reduce((sum, item) => sum + item.quantite, 0);
    const countElem = document.getElementById('cartCountNav');
    countElem.textContent = totalQuantity;
    countElem.style.display = totalQuantity > 0 ? 'inline' : 'none';
  }

  function supprimerProduit(index) {
    const cart = getCart();
    cart.splice(index, 1);
    saveCart(cart);
    displayCart();
    updateCartCount();
  }

  function modifierQuantite(index, nouvelleQuantite) {
    const cart = getCart();
    nouvelleQuantite = parseInt(nouvelleQuantite);
    if (nouvelleQuantite < 1) {
      supprimerProduit(index);
      return;
    }
    cart[index].quantite = nouvelleQuantite;
    saveCart(cart);
    displayCart();
    updateCartCount();
  }

  function displayCart() {
    const cart = getCart();
    const container = document.getElementById('cartItems');
    const totalElem = document.getElementById('totalPanier');
    container.innerHTML = '';

    if (cart.length === 0) {
      container.textContent = "Votre panier est vide.";
      totalElem.textContent = "Total : 0,00 ‚Ç¨";
      return;
    }

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr>
        <th>Image</th>
        <th>Nom</th>
        <th>Prix</th>
        <th>Quantit√©</th>
        <th>Sous-total</th>
        <th>Supprimer</th>
      </tr>`;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    let totalPrice = 0;

    cart.forEach((item, index) => {
      const sousTotal = item.prix * item.quantite;
      totalPrice += sousTotal;
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td><img src="${item.imageUrl || 'produit-removebg-preview.png'}" alt="Image du produit" width="60"></td>
        <td>${item.nom}</td>
        <td>${item.prix.toFixed(2)} ‚Ç¨</td>
        <td><input type="number" min="1" value="${item.quantite}" onchange="modifierQuantite(${index}, this.value)" style="width:60px;"></td>
        <td>${sousTotal.toFixed(2)} ‚Ç¨</td>
        <td><button onclick="supprimerProduit(${index})">üóëÔ∏è</button></td>`;
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    container.appendChild(table);

    totalElem.textContent = `Total : ${totalPrice.toFixed(2)} ‚Ç¨`;
  }

  function confirmerCommande() {
    const panier = getCart();
    if (panier.length === 0) {
      alert("Votre panier est vide.");
      return;
    }

    fetch("http://localhost:3000/api/commandes", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ utilisateur: userName, panier })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById("confirmationMessage").textContent = "‚úÖ Commande confirm√©e avec succ√®s.";
          localStorage.removeItem(`cart_${userName}`);
          displayCart();
          updateCartCount();
        } else {
          alert("Erreur lors de l'enregistrement.");
        }
      })
      .catch(error => {
        console.error(error);
        alert("Erreur de communication avec le serveur.");
      });
  }

  window.addEventListener('DOMContentLoaded', () => {
    displayCart();
    updateCartCount();
  });
</script>

<!-- fermerture de le pop up d'inscrition -->

<script>
  function toggleRegisterPopup() {
    const popup = document.getElementById("registerPopup");
    popup.classList.toggle("hidden");
  }

  document.addEventListener("DOMContentLoaded", function () {
    const registerForm = document.getElementById('registerForm');
    const registerMessage = document.getElementById('registerMessage');

    if (registerForm) {
      registerForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const username = document.getElementById('registerUsername').value.trim();
        const password = document.getElementById('registerPassword').value.trim();

        if (username && password) {
          let users = JSON.parse(localStorage.getItem('users')) || [];
          const userExists = users.some(user => user.username === username);

          if (userExists) {
            registerMessage.textContent = "Ce nom d'utilisateur existe d√©j√†.";
          } else {
            users.push({ username, password });
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('currentUser', username);

            registerMessage.textContent = "Compte cr√©√© avec succ√®s !";

            setTimeout(() => {
              console.log("Fermeture de la pop-up dans 1s...");
              toggleRegisterPopup();  // ferme la pop-up
              registerForm.reset();  // r√©initialise le formulaire
              registerMessage.textContent = ""; // vide le message
            }, 1000);

          }
        }
      });
    }
  });

  console.log("Fermeture de la pop-up dans 1s...");

</script>


<script>
  // Fonction pour ouvrir/fermer la popup
  function toggleRegisterPopup() {
    registerPopup.classList.toggle('hidden');
  }
</script>

<script>
  const loginForm = document.getElementById("loginForm");
  const loginMessage = document.getElementById("loginMessage");

  loginForm.addEventListener("submit", function (e) {
    e.preventDefault();

    const username = document.getElementById("loginUsername").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    const accounts = JSON.parse(localStorage.getItem("accounts")) || {};

    if (accounts[username] && accounts[username] === password) {
      localStorage.setItem("currentUser", username);
      loginMessage.textContent = "Connexion r√©ussie !";
      loginMessage.style.color = "lightgreen";

      // Ferme la popup apr√®s 500ms
      setTimeout(() => {
        document.getElementById("loginPopup").classList.add("hidden");
        loginMessage.textContent = "";
        loginForm.reset();
        location.reload(); // recharge la page ou redirige si tu veux
      }, 500);
    } else {
      loginMessage.textContent = "Nom d'utilisateur ou mot de passe incorrect.";
      loginMessage.style.color = "red";
    }
  });

  const loginPopup = document.getElementById("loginPopup");

  // Fermer la popup en cliquant √† l'ext√©rieur
  window.addEventListener("click", function (event) {
    if (event.target === loginPopup) {
      loginPopup.classList.add("hidden");
      document.getElementById("loginForm").reset();
      document.getElementById("loginMessage").textContent = "";
    }
  });


  // Fermer la popup d'inscription en cliquant √† l'ext√©rieur
  window.addEventListener("click", function (event) {
    if (event.target === registerPopup) {
      registerPopup.classList.add("hidden");
      document.getElementById("registerForm").reset();
      document.getElementById("registerMessage").textContent = "";
    }
  });
</script>



</body>

</html>
